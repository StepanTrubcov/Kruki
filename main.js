import { Telegraf } from "telegraf";
import shuffle from "./shuffle.js";
import { MongoClient } from "mongodb";
import dotenv from "dotenv";
import Lesson_1 from './Lessons/Lesson_1.js'
import Lesson_2 from './Lessons/Lesson_2.js'
import Staircase_simulator from './Staircase_simulator/Staircase_simulator.js'
import Lesson_3 from "./Lessons/Lesson_3.js";
import Lesson_4 from "./Lessons/Lesson_4.js";
import Lesson_5 from "./Lessons/Lesson_5.js";
import Lesson_6 from "./Lessons/Lesson_6.js";
import express from 'express';
import { readFileSync } from 'fs';
const answerStik = JSON.parse(readFileSync('./answerStik.json', 'utf-8'));
const baza_tests = JSON.parse(readFileSync('./baza_tests.json', 'utf-8'));

const app = express();
const PORT = process.env.PORT || 3000;

app.get('/', (req, res) => {
  res.send('ะััะบะพะฒะตะดัะตัะบะธะน ะฑะพั ัะฐะฑะพัะฐะตั!');
});

app.listen(PORT, () => {
  console.log(`ะกะตัะฒะตั ะทะฐะฟััะตะฝ ะฝะฐ ะฟะพััั ${PORT}`);
});

dotenv.config();

const token = "7919809731:AAHR9IPjbFtZondrgGKtZrP5d6L_b_vsTvA";
const mongo_URL = "mongodb://localhost:27017/Kruki";
const bot = new Telegraf(token);

// ะะฐัะฐะปะพ ะฑะฐะทั
let db;
async function connectDB() {
  try {
    const client = new MongoClient(mongo_URL);
    await client.connect();
    db = client.db("Kruki");
    console.log("โ ะฃัะฟะตัะฝะพะต ะฟะพะดะบะปััะตะฝะธะต ะบ MongoDB");
  } catch (error) {
    console.error("ะัะธะฑะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ MongoDB:", error);
  }
}

async function saveTestResult(userId, correctAnswers) {
  try {
    const collection = db.collection("user_results");

    const existingUser = await collection.findOne({ userId });

    if (existingUser) {
      await collection.updateOne({ userId }, { $set: { correctAnswers } });
      console.log(`๐ ะะฐะฝะฝัะต ะพะฑะฝะพะฒะปะตะฝั ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั ${userId}`);
    } else {
      await collection.insertOne({ userId, correctAnswers });
      console.log(`โ ะะฐะฝะฝัะต ะดะพะฑะฐะฒะปะตะฝั ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั ${userId}`);
    }
  } catch (error) {
    console.error("ะัะธะฑะบะฐ ัะพััะฐะฝะตะฝะธั ะดะฐะฝะฝัั ะฒ MongoDB:", error);
  }
}
// ะะฐะทะฐ ะดะฐะฝะฝัั

bot.start((ctx) => {
  ctx.reply('๐ง ะะพั ะฒ ัะฐะทัะฐะฑะพัะบะต โ ะฒะฐัะฐ ะฟะพะผะพัั ะฒะฐะถะฝะฐ!\n\nะัะธะฒะตัััะฒัั! ะกะตะนัะฐั ั ะฐะบัะธะฒะฝะพ ะดะพัะฐะฑะฐััะฒะฐั ััะพะณะพ ะฑะพัะฐ-ะฟะพะผะพัะฝะธะบะฐ ะฟะพ ะบััะบะพะฒะพะน ะฝะพัะฐัะธะธ. ะั ะพะดะฝะธ ะธะท ะฟะตัะฒัั, ะบัะพ ะตะณะพ ัะตััะธััะตั!\n\nะะฐะบ ะผะพะถะฝะพ ะฟะพะผะพัั?\n1๏ธโฃ ะัะพัะตััะธััะนัะต ััะพะบะธ (ะฟะตัะฒัะต 5 ะดะพัััะฟะฝั ัะถะต ัะตะนัะฐั) โ ะธ ัะฐััะบะฐะถะธัะต, ััะพ ะผะพะถะฝะพ ัะปัััะธัั.\n2๏ธโฃ ะกะบะพัะพ ะฑัะดะตั:\nะะพะดะฟะธัะบะฐ ะฝะฐ ะฒัะต ััะพะบะธ 200โฝ\n3๏ธโฃ ะัะปะธ ะฑะพั ัะถะต ะฒะฐะผ ะฟะพะผะพะณ โ ะฟะพะดะดะตัะถะธัะต ะฟัะพะตะบั ะดะพะฑัะพะฒะพะปัะฝัะผ ะฟะพะถะตััะฒะพะฒะฐะฝะธะตะผ. ะะฐะถะต 50โฝ ััะบะพััั ัะฐะทัะฐะฑะพัะบั!\n\nะะพัะตะผั ััะพ ะฒะฐะถะฝะพ?\nะะฐัะฐ ะพะฑัะฐัะฝะฐั ัะฒัะทั ะธ ะฟะพะดะดะตัะถะบะฐ ะฟะพะผะพะณัั ัะดะตะปะฐัั ะฑะพัะฐ ะฟะพ-ะฝะฐััะพััะตะผั ะฟะพะปะตะทะฝัะผ ะดะปั ะฒัะตั, ะบัะพ ะธะทััะฐะตั ัะตัะบะพะฒะฝะพะต ะฟะตะฝะธะต.\n\n๐ ะกะฟะฐัะธะฑะพ, ััะพ ะฒั ั ะฝะฐะผะธ ะฝะฐ ััะพะผ ะฟััะธ!')

  ctx.reply("๐ต ะะพะฑัะพ ะฟะพะถะฐะปะพะฒะฐัั ะฒ ะผะธั ะดัะตะฒะฝะตััััะบะพะณะพ ัะตัะบะพะฒะฝะพะณะพ ะฟะตะฝะธั!\n\nะญัะพั ะฑะพั ะฟะพะผะพะถะตั ะฒะฐะผ:\nโข ะะทััะธัั ะบััะบะพะฒัั ะฝะพัะฐัะธั ั ะฝัะปั\nโข ะัะพะฒะตัะธัั ะทะฝะฐะฝะธั ะฒ ะธะฝัะตัะฐะบัะธะฒะฝัั ัะตััะฐั\nโข ะััะพัะธัั ะฝะฐะฒัะบะธ ะฝะฐ ััะตะฝะฐะถััะฐั\n\nะัะฑะตัะธัะต ะดะตะนััะฒะธะต:\nะฃัะพะบะธ โ ะะพัะฐะณะพะฒะพะต ะธะทััะตะฝะธะต ะบััะบะพะฒ\nะขะตััั โ ะัะพะฒะตัะบะฐ ะทะฝะฐะฝะธะน\nะขัะตะฝะฐะถัั โ ะัะฐะบัะธะบะฐ ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธั ัะธะผะฒะพะปะพะฒ\n\nะะฐัะฝะธัะต ั ััะพะบะฐ ะธะปะธ ััะฐะทั ะธัะฟััะฐะนัะต ัะตะฑั ะฒ ัะตััะต!", {
    reply_markup: {
      inline_keyboard: [
        [
          { text: "๐ ะฃัะพะบะธ", callback_data: "lessons" },
          { text: "๐ ะขะตััั", callback_data: "button_test" }
        ],
        [
          { text: "๐๏ธ ะขัะตะฝะฐะถัั ะปะตััะฝะธัั", callback_data: "staircase_simulator" },
          { text: "โน๏ธ ะ ะบััะบะฐั", callback_data: "kruki" }
        ],
        [
          { text: "ะะพะดะดะตัะถะบะฐ", callback_data: "support" },
        ]
      ],
    },
  });
});

const userProgress = {};

bot.command("test", (ctx) => {
  return ctx.reply("๐ง ะัะพะฒะตัััะต ัะฒะพะธ ะทะฝะฐะฝะธั\nะะพัะปะต ะฟัะพัะพะถะดะตะฝะธั ะฒั ัะทะฝะฐะตัะต ัะฒะพะน ััะพะฒะตะฝั ะธ ะฟะพะปััะธัะต ัะตะบะพะผะตะฝะดะฐัะธะธ!", {
    reply_markup: {
      inline_keyboard: [
        [{ text: "ะขะตัั 1 (ะฟะพ ะฃัะพะบั 1) โ 5 ะฒะพะฟัะพัะพะฒ", callback_data: "test_1" }, { text: "ะขะตัั 2 (ะฟะพ ะฃัะพะบั 2) โ 11 ะฒะพะฟัะพัะพะฒ", callback_data: "test_2" }],
        [{ text: "ะขะตัั 3 (ะฟะพ ะฃัะพะบั 3) โ 8 ะฒะพะฟัะพัะพะฒ", callback_data: "test_3" }]
      ],
    },
  });
});

bot.command("kruki", (ctx) => {
  return ctx.reply("ะะะฎะะฬ (ะทะฝะฐยญะผัยญะฝะฐ), ะทะฝะฐยญะบะธ, ะฑะตะทยญะปะธยญะฝะตะนยญะฝัั ะฟะตะฒยญัะตยญัะบะธั ะฝะพยญัะฐยญัะธะน. ะััยญะบะพยญะฒะฐั (ะฟะพ ะฝะฐะทะฒ. ะพะดยญะฝะพยญะณะพ ะธะท ะพัะฝ. ะทะฝะฐยญะบะพะฒ โ ะบััยญะบะฐ), ะพะฝะฐ ะถะต ััะพะปยญะฟะพยญะฒะฐั, ะธะปะธ ะทะฝะฐยญะผะตะฝยญะฝะฐั, ะฝะพยญัะฐยญัะธั ะฒะตยญะดัั ัะฒะพั ะฟัะพยญะธัยญัะพยญะถยญะดะตยญะฝะธะต ะพั ัะฐะฝยญะฝะตยญะฒะธยญะทะฐะฝยญัะธะนยญัะบะพะน ะฝะพยญัะฐยญัะธะธ ะธ ัะฒยญะปัยญะตัยญัั ะพัะฝ. ัะพัยญะผะพะน ะดั.-ััั. ะผัะท. ะฟะธััยญะผะตะฝยญะฝะพยญััะธ. ะั ะพัะด. ะทะฝะฐยญะบะธ ัะพยญััะฐยญะฝะธยญะปะธ ะณัะตั. ะฝะฐยญะทะฒะฐยญะฝะธั (ะฝะฐะฟั., ะฟะฐยญัะฐยญะบะปะธั). ะะพะปัยญัะธะฝยญััยญะฒะพ ะทะฝะฐยญะบะพะฒ ะฟะพยญะปัยญัะธยญะปะพ ััั. ะฝะฐยญะทะฒะฐยญะฝะธั, ัะฒัยญะทะฐะฝยญะฝัะต ั ะธั ะฒะฝะตัยญะฝะธะผ ะฒะธยญะดะพะผ: ะฟะฐะปยญะบะฐ, ัััะตยญะปะฐ, ะทะฐยญะฟัยญัะฐั ะธ ั. ะฟ. ะ ัะฐะทยญะฒะธยญัะธะธ ะบััยญะบะพยญะฒะพะน ะฝะพยญัะฐยญัะธะธ ะฒัยญะดะตยญะปัยญัั 3 ะฟะตยญัะธะพยญะดะฐ: ัะฐะฝยญะฝะธะน (11โ14 ะฒะฒ.), ััะตะดยญะฝะธะน (15 โ ะฝะฐั. 17 ะฒะฒ.) ะธ ะฟะพะทะดยญะฝะธะน (ั ัะตั. 17 ะฒ.). ะะพยญัะฐยญัะธั ะฟะตัยญะฒัั 2 ะฟะตยญัะธะพยญะดะพะฒ ะฒ ัะพยญัะตยญัะฐยญะฝะธะธ ั ะผะพยญะปะธัยญะฒะพยญัะปะพะฒยญะฝัะผ ัะตะบยญััะพะผ ะฟะพยญะทะฒะพยญะปัยญะตั ััยญะดะธัั ะพ ัะธัยญะผะต ะฟะตัยญะฝะพยญะฟะตยญะฝะธะน, ะฝะพ ะธั ะทะฒัยญะบะพยญะฒัยญัะพัยญะฝะฐั ัะพยญััะฐะฒยญะปััยญัะฐั ะฝะต ะฟะพะดยญะดะฐยญััยญัั ะดะตยญัะธัยญัะพะฒยญะบะต. ะ 17 ะฒ. ะฒ ะฝะพยญัะฐยญัะธะธ ะฟะพัยญะฒะธยญะปะฐัั ะปะฐยญะดะพะทยญะฒัยญะบะพยญััะดยญะฝะฐั ะพะฟยญัะตยญะดะตยญะปัะฝยญะฝะพััั ะฑะปะฐยญะณะพยญะดะฐยญัั ะบะธยญะฝะพยญะฒะฐัยญะฝัะผ ะฟะพยญะผะตยญัะฐะผ, ะทะฐยญัะตะผ ััยญัะตยญะฒัะผ ะฟัะธะทะฝaฬะบะฐะผ, ััะพ ะฝัยญะฝะต ะฟะพยญะทะฒะพยญะปัยญะตั ัะฐัยญัะธัยญัะพยญะฒัยญะฒะฐัั ะทะฒัยญะบะพยญะฒัยญัะพัยญะฝัั ะปะธยญะฝะธั. ะะฐะทยญะปะธยญัะฐยญัั ะฑะตัยญะฟะพยญะผะตัยญะฝัะต, ะฟะพยญะผะตัยญะฝัะต, ะพะดยญะฝะพยญะฒัะตยญะผะตะฝยญะฝะพ ะฟะพยญะผะตัยญะฝัะต ะธ ะฟัะธยญะทะฝะฐัยญะฝัะต ะบััยญะบะพยญะฒัะต ััยญะบะพยญะฟะธยญัะธ.")
});

bot.command("lessons", (ctx) => {
  return ctx.reply("๐ ะฃัะพะบะธ ะบััะบะพะฒะพะณะพ ะฟะธััะผะฐ\nะะฐะถะดัะน ััะพะบ โ ััะพ ัะฐะณ ะบ ะผะฐััะตัััะฒั!\nะะตะบะพะผะตะฝะดัะตะผ ะฟัะพัะพะดะธัั ะฟะพ ะพะดะฝะพะผั ััะพะบั ะฒ ะดะตะฝั ะดะปั ะปัััะตะณะพ ััะฒะพะตะฝะธั.", {
    reply_markup: {
      inline_keyboard: [
        [
          { text: "ะฃัะพะบ 1 โ (ะฟะพะผะตัั)", callback_data: "lesson_1" },
          { text: "ะฃัะพะบ 2 โ (ะบััะบ ะธ ะฟะฐัะฐะบะปะธั)", callback_data: "lesson_2" }
        ],
        [
          { text: "ะฃัะพะบ 3 โ (ััะพะฟะธัะฐ, ะทะฐะฟะธัะฐั, ะฟะฐะปะบะฐ)", callback_data: "lesson_3" },
          { text: "ะฃัะพะบ 4 - (ะบะปััั, ัะตะปัััะบะฐ, ะฟะพะดัะฐัะธะต, ัะบะฐะผะตะนัะธ, ะฟะฐะปะบะธ)", callback_data: "lesson_4" },
        ],
        [
          { text: "ะฃัะพะบ 5 - (ะดะตัะฑะธัะฐ, ะฟะตัะตะฒะพะดะบะธ, ะณะพะปัะฑัะธะบะธ,ัะฐัะบะธ)", callback_data: "lesson_5" },
        ],
      ],
    },
  });
});

const i = [0];

bot.on("callback_query", (ctx) => {
  const userId = ctx.from.id;
  const buttonData = ctx.callbackQuery.data;

  Lesson_1(ctx, buttonData)
  Lesson_2(ctx, buttonData)
  Lesson_3(ctx, buttonData)
  Lesson_4(ctx, buttonData)
  Lesson_5(ctx, buttonData)
  Lesson_6(ctx, buttonData)
  Staircase_simulator(ctx, buttonData)

  if (buttonData === "lessons") {
    return ctx.reply("๐ ะฃัะพะบะธ ะบััะบะพะฒะพะณะพ ะฟะธััะผะฐ\nะะฐะถะดัะน ััะพะบ โ ััะพ ัะฐะณ ะบ ะผะฐััะตัััะฒั!\nะะตะบะพะผะตะฝะดัะตะผ ะฟัะพัะพะดะธัั ะฟะพ ะพะดะฝะพะผั ััะพะบั ะฒ ะดะตะฝั ะดะปั ะปัััะตะณะพ ััะฒะพะตะฝะธั.", {
      reply_markup: {
        inline_keyboard: [
          [
            { text: "ะฃัะพะบ 1 โ (ะฟะพะผะตัั)", callback_data: "lesson_1" },
            { text: "ะฃัะพะบ 2 โ (ะบััะบะธ, ะฟะฐัะฐะบะปะธัั )", callback_data: "lesson_2" }
          ],
          [
            { text: "ะฃัะพะบ 3 โ (ััะพะฟะธัั, ะทะฐะฟะธััะธ, ะฟะฐะปะบะธ)", callback_data: "lesson_3" },
            { text: "ะฃัะพะบ 4 - (ะบะปััั, ัะตะปัััะบะฐ, ะฟะพะดัะฐัะธะต, ัะบะฐะผะตะนัะธ, ะฟะฐะปะบะธ)", callback_data: "lesson_4" },
          ],
          [
            { text: "ะฃัะพะบ 5 - (ะดะตัะฑะธัะฐ, ะฟะตัะตะฒะพะดะบะธ, ะณะพะปัะฑัะธะบะธ,ัะฐัะบะธ)", callback_data: "lesson_5" },
          ],
        ],
      },
    });
  }

  if (buttonData === "kruki") {
    return ctx.reply("ะะะฎะะฬ (ะทะฝะฐยญะผัยญะฝะฐ), ะทะฝะฐยญะบะธ, ะฑะตะทยญะปะธยญะฝะตะนยญะฝัั ะฟะตะฒยญัะตยญัะบะธั ะฝะพยญัะฐยญัะธะน. ะััยญะบะพยญะฒะฐั (ะฟะพ ะฝะฐะทะฒ. ะพะดยญะฝะพยญะณะพ ะธะท ะพัะฝ. ะทะฝะฐยญะบะพะฒ โ ะบััยญะบะฐ), ะพะฝะฐ ะถะต ััะพะปยญะฟะพยญะฒะฐั, ะธะปะธ ะทะฝะฐยญะผะตะฝยญะฝะฐั, ะฝะพยญัะฐยญัะธั ะฒะตยญะดัั ัะฒะพั ะฟัะพยญะธัยญัะพยญะถยญะดะตยญะฝะธะต ะพั ัะฐะฝยญะฝะตยญะฒะธยญะทะฐะฝยญัะธะนยญัะบะพะน ะฝะพยญัะฐยญัะธะธ ะธ ัะฒยญะปัยญะตัยญัั ะพัะฝ. ัะพัยญะผะพะน ะดั.-ััั. ะผัะท. ะฟะธััยญะผะตะฝยญะฝะพยญััะธ. ะั ะพัะด. ะทะฝะฐยญะบะธ ัะพยญััะฐยญะฝะธยญะปะธ ะณัะตั. ะฝะฐยญะทะฒะฐยญะฝะธั (ะฝะฐะฟั., ะฟะฐยญัะฐยญะบะปะธั). ะะพะปัยญัะธะฝยญััยญะฒะพ ะทะฝะฐยญะบะพะฒ ะฟะพยญะปัยญัะธยญะปะพ ััั. ะฝะฐยญะทะฒะฐยญะฝะธั, ัะฒัยญะทะฐะฝยญะฝัะต ั ะธั ะฒะฝะตัยญะฝะธะผ ะฒะธยญะดะพะผ: ะฟะฐะปยญะบะฐ, ัััะตยญะปะฐ, ะทะฐยญะฟัยญัะฐั ะธ ั. ะฟ. ะ ัะฐะทยญะฒะธยญัะธะธ ะบััยญะบะพยญะฒะพะน ะฝะพยญัะฐยญัะธะธ ะฒัยญะดะตยญะปัยญัั 3 ะฟะตยญัะธะพยญะดะฐ: ัะฐะฝยญะฝะธะน (11โ14 ะฒะฒ.), ััะตะดยญะฝะธะน (15 โ ะฝะฐั. 17 ะฒะฒ.) ะธ ะฟะพะทะดยญะฝะธะน (ั ัะตั. 17 ะฒ.). ะะพยญัะฐยญัะธั ะฟะตัยญะฒัั 2 ะฟะตยญัะธะพยญะดะพะฒ ะฒ ัะพยญัะตยญัะฐยญะฝะธะธ ั ะผะพยญะปะธัยญะฒะพยญัะปะพะฒยญะฝัะผ ัะตะบยญััะพะผ ะฟะพยญะทะฒะพยญะปัยญะตั ััยญะดะธัั ะพ ัะธัยญะผะต ะฟะตัยญะฝะพยญะฟะตยญะฝะธะน, ะฝะพ ะธั ะทะฒัยญะบะพยญะฒัยญัะพัยญะฝะฐั ัะพยญััะฐะฒยญะปััยญัะฐั ะฝะต ะฟะพะดยญะดะฐยญััยญัั ะดะตยญัะธัยญัะพะฒยญะบะต. ะ 17 ะฒ. ะฒ ะฝะพยญัะฐยญัะธะธ ะฟะพัยญะฒะธยญะปะฐัั ะปะฐยญะดะพะทยญะฒัยญะบะพยญััะดยญะฝะฐั ะพะฟยญัะตยญะดะตยญะปัะฝยญะฝะพััั ะฑะปะฐยญะณะพยญะดะฐยญัั ะบะธยญะฝะพยญะฒะฐัยญะฝัะผ ะฟะพยญะผะตยญัะฐะผ, ะทะฐยญัะตะผ ััยญัะตยญะฒัะผ ะฟัะธะทะฝaฬะบะฐะผ, ััะพ ะฝัยญะฝะต ะฟะพยญะทะฒะพยญะปัยญะตั ัะฐัยญัะธัยญัะพยญะฒัยญะฒะฐัั ะทะฒัยญะบะพยญะฒัยญัะพัยญะฝัั ะปะธยญะฝะธั. ะะฐะทยญะปะธยญัะฐยญัั ะฑะตัยญะฟะพยญะผะตัยญะฝัะต, ะฟะพยญะผะตัยญะฝัะต, ะพะดยญะฝะพยญะฒัะตยญะผะตะฝยญะฝะพ ะฟะพยญะผะตัยญะฝัะต ะธ ะฟัะธยญะทะฝะฐัยญะฝัะต ะบััยญะบะพยญะฒัะต ััยญะบะพยญะฟะธยญัะธ.")
  }

  if (buttonData === "button_test") {
    return ctx.reply("๐ง ะัะพะฒะตัััะต ัะฒะพะธ ะทะฝะฐะฝะธั\nะะพัะปะต ะฟัะพัะพะถะดะตะฝะธั ะฒั ัะทะฝะฐะตัะต ัะฒะพะน ััะพะฒะตะฝั ะธ ะฟะพะปััะธัะต ัะตะบะพะผะตะฝะดะฐัะธะธ!", {
      reply_markup: {
        inline_keyboard: [
          [{ text: "ะขะตัั 1 (ะฟะพ ะฃัะพะบั 1) โ 5 ะฒะพะฟัะพัะพะฒ", callback_data: "test_1" }, { text: "ะขะตัั 2 (ะฟะพ ะฃัะพะบั 2) โ 11 ะฒะพะฟัะพัะพะฒ", callback_data: "test_2" }],
          [{ text: "ะขะตัั 3 (ะฟะพ ะฃัะพะบั 3) โ 8 ะฒะพะฟัะพัะพะฒ", callback_data: "test_3" }]
        ],
      },
    });
  }

  if (buttonData === "test_2") {
    ctx.reply('ะญะขะะข ะขะะกะข ะะขะะะกะะขะกะฏ ะ ะฃะะะะฃ 2 \nะขะตัั ะฑัะดะตั ะฟัะพัะพะดะธัั ะบะฐะบ ะธ ัะตัั 1. ะ ะฝัะผ 11 ะฒะพะฟัะพัะพะฒ. ะะฝะธะผะฐัะตะปัะฝะพ ัะธัะฐะนัะต ะฒะพะฟัะพัั! ะะฐัะธะฝะฐะนัะต ะธ ัะดะฐัะธ!', {
      reply_markup: {
        inline_keyboard: [[{ text: "ะะฐัะฐัั ัะตัั 2", callback_data: "beginning_test_2" }]],
      },
    }
    )
  }

  if (buttonData === "beginning_test_2") {
    if (!userProgress[userId]) {
      userProgress[userId] = {
        progress: 0,
        numTrueAnswer: 0,
      };
    }
    i.splice(0, 1, 1)
    userProgress[userId].progress = 0;
    userProgress[userId].numTrueAnswer = 0;
  }

  if (buttonData === "test_3") {
    if (!userProgress[userId]) {
      userProgress[userId] = {
        progress: 0,
        numTrueAnswer: 0,
      };
    }
    i.splice(0, 1, 2)
    userProgress[userId].progress = 0;
    userProgress[userId].numTrueAnswer = 0;
  }

  if (buttonData === "true_answer") {
    userProgress[userId].numTrueAnswer++;
    userProgress[userId].progress++;
    if (userProgress[userId].progress < baza_tests[i[0]].length) {
      ctx.reply("ะัะฐะฒะธะปัะฝะพ!!๐");
    }
  }

  if (
    buttonData === "false_2" ||
    buttonData === "false_3" ||
    buttonData === "false_4"
  ) {
    userProgress[userId].progress++;
    if (userProgress[userId].progress < baza_tests[i[0]].length) {
      ctx.reply("ะะต ะฟัะฐะฒะธะปัะฝะพ๐");
    }
  }


  if (buttonData === "test_1") {
    ctx.reply('ะญะขะะข ะขะะกะข ะะขะะะกะะขะกะฏ ะ ะฃะะะ 1 \nะะฟะธัะฐะฝะธะต ัะตััะฐ:\nะ ััะพะผ ะธะฝัะตัะฐะบัะธะฒะฝะพะผ ัะตััะต ะฒะฐะผ ะฟัะตะดััะพะธั ะพัะฒะตัะธัั ะฝะฐ ััะด ะฒะพะฟัะพัะพะฒ, ะฝะฐะถะธะผะฐั ะฝะฐ ะบะฝะพะฟะบะธ. ะะฐะถะดัะน ะฒะพะฟัะพั ะฑัะดะตั ะธะผะตัั 4 ะฒะฐัะธะฐะฝัะฐ ะพัะฒะตัะฐ. ะัะพััะพ ะฝะฐะถะผะธัะต ะฝะฐ ะบะฝะพะฟะบั ั ะพัะฒะตัะพะผ, ะบะพัะพััะน, ะฟะพ ะฒะฐัะตะผั ะผะฝะตะฝะธั, ะฟัะฐะฒะธะปัะฝัะน.\nะะฐะบ ััะพ ัะฐะฑะพัะฐะตั:\n- ะั ะฑัะดะตัะต ะฒะธะดะตัั ะฒะพะฟัะพั ะธ 4 ะบะฝะพะฟะบะธ ั ะฒะฐัะธะฐะฝัะฐะผะธ ะพัะฒะตัะพะฒ.\n- ะะฐะถะผะธัะต ะฝะฐ ะพะดะฝั ะธะท ะบะฝะพะฟะพะบ, ััะพะฑั ะฒัะฑัะฐัั ะพัะฒะตั.\n- ะะพัะปะต ะบะฐะถะดะพะณะพ ะฒัะฑะพัะฐ ะฒั ะฟะพะปััะธัะต ะฟะพะดัะบะฐะทะบั ะพ ัะพะผ, ะฟัะฐะฒะธะปัะฝัะน ะฒะฐั ะพัะฒะตั ะธะปะธ ะฝะตั, ะฐ ัะฐะบะถะต ะฟะพัะฒะธัััั ัะปะตะดััะธะน ะฒะพะฟัะพั.\nะขะตัั ะธะผะตะตั 5 ะฒะพะฟัะพัะพะฒ.ะะฐัะธะฝะฐะนัะต ัะตัั, ะธ ัะดะฐัะธ!', {
      reply_markup: {
        inline_keyboard: [[{ text: "ะะฐัะฐัั ัะตัั 1", callback_data: "beginning_test_1" }]],
      },
    }
    )
  }

  if (buttonData === "beginning_test_1") {
    if (!userProgress[userId]) {
      userProgress[userId] = {
        progress: 0,
        numTrueAnswer: 0,
      };
    }

    i.splice(0, 1, 0)
    userProgress[userId].progress = 0;
    userProgress[userId].numTrueAnswer = 0;
  }

  if (
    buttonData === "false_2" ||
    buttonData === "false_3" ||
    buttonData === "false_4" ||
    buttonData === "beginning_test_1" ||
    buttonData === "beginning_test_2" ||
    buttonData === "test_3" ||
    buttonData === "true_answer"
  ) {
    if (userProgress[userId].progress < baza_tests[i[0]].length) {
      sendQuestion(ctx, userId);
    } else {
      ctx.reply("ะขะตัั ะทะฐะฒะตััะตะฝ!");

      saveTestResult(userId, userProgress[userId].numTrueAnswer);

      if (
        userProgress[userId].numTrueAnswer >= 0 &&
        userProgress[userId].numTrueAnswer <= 4
      ) {
        ctx.reply(
          `ะขั ะพัะฒะตัะธะป ะฝะฐ ${userProgress[userId].numTrueAnswer} ะธะท ${baza_tests[i[0]].length}`
        );
        ctx.replyWithSticker(answerStik.id_0_4);
      } else if (
        userProgress[userId].numTrueAnswer >= 5 &&
        userProgress[userId].numTrueAnswer <= 7
      ) {
        ctx.reply(
          `ะขั ะพัะฒะตัะธะป ะฝะฐ ${userProgress[userId].numTrueAnswer} ะธะท ${baza_tests[i[0]].length}`
        );
        ctx.replyWithSticker(answerStik.id_5_7);
      } else if (
        userProgress[userId].numTrueAnswer >= 8 &&
        userProgress[userId].numTrueAnswer <= 9
      ) {
        ctx.reply(
          `ะขั ะพัะฒะตัะธะป ะฝะฐ ${userProgress[userId].numTrueAnswer} ะธะท ${baza_tests[i[0]].length}`
        );
        ctx.replyWithSticker(answerStik.id_8_9);
      } else if (userProgress[userId].numTrueAnswer == 10) {
        ctx.reply(
          `ะขั ะพัะฒะตัะธะป ะฝะฐ ${userProgress[userId].numTrueAnswer} ะธะท ${baza_tests[i[0]].length}`
        );
        ctx.replyWithSticker(answerStik.id_10);
      }
      else if (userProgress[userId].numTrueAnswer == 11) {
        ctx.reply(
          `ะขั ะพัะฒะตัะธะป ะฝะฐ ${userProgress[userId].numTrueAnswer} ะธะท ${baza_tests[i[0]].length}`
        );
        ctx.replyWithSticker(answerStik.id_10);
      }
      delete userProgress[userId];
    }
  }
}
);

function sendQuestion(ctx, userId) {
  const question = baza_tests[i[0]][userProgress[userId].progress];
  const answer = [
    [
      { text: question.answer[2], callback_data: "false_3" },
      { text: question.answer[3], callback_data: "false_4" },
    ],
    [
      { text: question.answer[0], callback_data: "true_answer" },
      { text: question.answer[1], callback_data: "false_2" },
    ],
  ];
  const mixer0 = shuffle(answer[0]);
  const mixer1 = shuffle(answer[1]);
  const answers = [
    mixer0,
    mixer1
  ];
  const mixer = shuffle(answers);
  setTimeout(() => {
    ctx.replyWithSticker(question.sticker);
  }, 200);
  setTimeout(() => {
    ctx.reply(question.text, {
      reply_markup: {
        inline_keyboard: mixer,
      },
    });
  }, 500);
}

(async () => {
  await connectDB();
  bot.launch();
  console.log("๐ค ะะพั ะทะฐะฟััะตะฝ!");
})();
